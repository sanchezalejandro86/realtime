doctype html
html
    head
        meta(name='viewport', content='width=device-width, initial-scale=1.0')
        meta(http-equiv='content-language', content='es')
        meta(name="robots" content="INDEX,FOLLOW")
        link(href='/stylesheets/bootstrap.min.css', rel='stylesheet', media='screen')
        link(href='/stylesheets/font-awesome.min.css', rel='stylesheet', media='screen')
        link(rel='stylesheet', href='/stylesheets/style.css')
    body
        .navbar.navbar-inverse.set-radius-zero
            .container
                .navbar-header
                    button.navbar-toggle(type="button", data-toggle="collapse", data-target=".navbar-collapse")
                        span.icon-bar
                        span.icon-bar
                        span.icon-bar
                    a.navbar-brand(href="/")
                        img(src="images/logo.png")
                .left-div
                    .user-settings-wrapper
                        ul.nav
                            li.dropdown
                                a.dropdown-toggle(data-toggle="dropdown", href="#", aria-expanded="false")
                                    span.glyphicon.glyphicon-user(style="font-size: 25px")
                                .dropdown-menu.dropdown-settings
                                    .media
                                        a.media-left(href="#")
                                            img.img-rounded(src="images/64-64.jpg", alt="")
                                        .media-body
                                            h4.media-heading Alejandro Sánchez
                                            h5 Administrador
                                    hr
                                    h5
                                        strong Biografía
                                    span Ingeniero en Sistemas de Información
                                    hr
                                    a.btn.btn-info.btn-sm(href="#") Perfil &nbsp;
                                    a.btn.btn-danger.btn-sm(href="#") Cerrar Sesión
        section.menu-section
            .container
                .row
                    .col-md-12
                        .navbar-collapse.collapse
                            ul.nav.navbar-nav.navbar-right#menu-top
                                li
                                    a.menu-top-active(href="#") Realtime
                                li
                                    a(href="#") Menu 2
                                li
                                    a(href="#") Menu 3
                                li
                                    a(href="#") Menu 4
                                li
                                    a(href="#") Menu 5

        .content-wrapper
            .container
                .row
                    .col-md-12#search-panel
                        script.
                              (function() {
                                var cx = '004468690808925015633:ehl2wqargfg';
                                var gcse = document.createElement('script');
                                gcse.type = 'text/javascript';
                                gcse.async = true;
                                gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                                    '//cse.google.com/cse.js?cx=' + cx;
                                var s = document.getElementsByTagName('script')[0];
                                s.parentNode.insertBefore(gcse, s);
                              })();
                        gcse:search(disableWebSearch="true", enableImageSearch="true", image_lr="lang_en")
                        //.gcse-searchbox(data-disableWebSearch="true", data-enableImageSearch="true")
                .row
                    .col-md-6
                        video#vid(height="400px",autoplay,controls)
                    .col-md-6#page-wrap
                        #chat-wrap
                            #chat-area
                        #send-message-area
                            textarea#sendie
                if profesor
                    .row
                        .form-group.col-lg-12
                            label.col-md-2.control-label Agregar Alumno Al Video:
                            .col-md-10
                                input(type="text")#clientId
                else
                    .row
                        .form-group.col-lg-12
                            label.col-md-1.control-label Mi Id:
                            .col-md-11
                                input(type="text", disabled)#alumnoPeerId

        footer
            .container
                .row
                    .col-md-12 &copy; 2015 Unlimited Solutions

        script(type='text/javascript', src='/javascripts/jquery-2.1.4.min.js')
        script(type='text/javascript', src='/javascripts/bootstrap.min.js')
        script(type='text/javascript', src='/javascripts/socket.io-1.3.5.js')
        script(type='text/javascript', src='/javascripts/peer.js')
        script.
            var socket = io();
            var peer = new Peer({key: 'bp70suzmx5ok1emi'});
            var profesor = '#{profesor}' == '1';
            var mediaStream = null;

            function sendSearch(){
                socket.emit('search changed', $("input.gsc-input").val());
            }
            function sendSearch2(e){
                /*if(e.which == 17){
                 $('input.gsc-search-button').click();
                 }*/ //Activa la busqueda con el CTRL
                $('input.gsc-search-button').click();

            }

            function activateSearchEvents(){
                $("#search-panel").on("click", "input.gsc-search-button", sendSearch);
                $("#search-panel").on("keyup", ".gsc-input", sendSearch2);
                //$("#search-panel").on("keydown", ".gsc-input", sendSearch2);

            }

            function deactivateSearchEvents(){
                $("#search-panel").off("click", "input.gsc-search-button", sendSearch);
                $("#search-panel").off("keyup", ".gsc-input", sendSearch2);
                //$("#search-panel").off("keydown", ".gsc-input", sendSearch2);
            }

            $(document).ready(function(){

                activateSearchEvents();

                $("#sendie").keyup(function(e){
                    if(e.which == 13){
                        var text = $.trim($("#sendie").val());
                        if(text != ""){
                            var randomInputId = Math.floor((Math.random() * 1000000000) + 1);
                            socket.emit('newMessageChat', { message: text, inputId: randomInputId });
                            $("#sendie").val("");
                        }
                    }
                });

                $("#chat-area").on("keyup", ".chatInput", function(e){
                    if(e.which == 13){
                        var inputId = e.target.id;
                        var inputValue = $.trim($("#" + inputId).val());
                        if(inputValue != ""){
                            socket.emit('messageChatChanged', { message: inputValue, inputId: inputId});
                        }
                    }
                });

                socket.on('search changed', function(msg){
                   $('input.gsc-input').val(msg);
                    deactivateSearchEvents();
                   $('input.gsc-search-button').click();
                    activateSearchEvents();
                });

                socket.on('newMessageChat', function (data) {
                    $('#chat-area').append('<input id="'+data.inputId+'" type="text" class="input form-control chatInput" value="'+ data.message +'"></input>');
                    document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
                });

                socket.on('messageChatChanged', function (data) {
                    $("#" + data.inputId).val(data.message);
                });

                if(profesor){ //el profesor activa su camara para stremear a los alumnos
                    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

                    navigator.getUserMedia({audio: true, video:true},
                    function(localMediaStream){
                        console.log("JOYAAA");
                        mediaStream = localMediaStream;
                        var vid = document.getElementById('vid');
                        vid.src = window.URL.createObjectURL(localMediaStream);
                    },function(err) {
                        console.log('The following error occurred when trying to use getUserMedia: ' + err);
                    });

                    $("#clientId").keyup(function(e){
                        if(e.which == 13){
                            var peerClientId = $.trim($("#clientId").val());
                            if(peerClientId != ""){
                                peer.call(peerClientId, mediaStream);
                            }
                        }
                    });
                } else { //los alumnos abren el peer y esperan la conexion del profesor
                    peer.on('open', function (id) {
                        $("#alumnoPeerId").val(id); //este peerId es el que pone el profesor para stremearle el audio/video
                    });

                    $("#vid").hide();

                    peer.on('call', function (call) {
                        call.answer(null);//contesto con null para que la comunicacion sea unidireccional

                        call.on('stream', function (stream) {
                            var vidCliente = document.getElementById('vid');
                            vidCliente.src = window.URL.createObjectURL(stream);
                            $("#vid").show();
                        });
                    });
                }



            });