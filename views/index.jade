doctype html
html(style="height: 100%")
    head
        meta(name='viewport', content='width=device-width, initial-scale=1.0')
        meta(http-equiv='content-language', content='es')
        meta(name="robots" content="INDEX,FOLLOW")
        link(href='/stylesheets/bootstrap.min.css', rel='stylesheet', media='screen')
        link(href='/stylesheets/font-awesome.min.css', rel='stylesheet', media='screen')
        link(rel='stylesheet', href='/stylesheets/style.css')
    body
        header
            .navbar.navbar-inverse.set-radius-zero
                .container
                    .navbar-header
                        button.navbar-toggle(type="button", data-toggle="collapse", data-target=".navbar-collapse")
                            span.icon-bar
                            span.icon-bar
                            span.icon-bar
                        a.navbar-brand(href="/")
                            img(src="/images/logo.png")
                    .left-div
                        .user-settings-wrapper
                            ul.nav
                                li.dropdown(style="margin-right: 60px;")
                                    a.dropdown-toggle(data-toggle="dropdown", href="#", aria-expanded="false")
                                        span.glyphicon.glyphicon-user(style="font-size: 25px")
                                    .dropdown-menu.dropdown-settings
                                        .media
                                            a.media-left(href="#")
                                                img.img-rounded(src="/images/64-64.jpg", alt="")
                                            .media-body
                                                h4.media-heading Alejandro Sánchez
                                                h5 Administrador
                                        hr
                                        h5
                                            strong(style="color:black;") Biografía
                                        span(style="color:black;") Ingeniero en Sistemas de Información
                                        hr
                                        a.btn.btn-info.btn-sm(href="#") Perfil &nbsp;
                                        a.btn.btn-danger.btn-sm(href="#") Cerrar Sesión
            section.menu-section
                .container
                    .row
                        .col-xs-12
                            .navbar-collapse.collapse
                                ul.nav.navbar-nav.navbar-right#menu-top
                                    li
                                        a.menu-top-active(href="#") Realtime
                                    li
                                        a(href="#") Menu 2
                                    li
                                        a(href="#") Menu 3
                                    li
                                        a(href="#") Menu 4
                                    li
                                        a(href="#") Menu 5

        content
            .content-wrapper
                .container
                    .row
                        .col-xs-6
                            .row
                                .col-xs-12
                                    #chat-wrap
                                        #chat-area

                        .col-xs-6#search-panel
                            .row
                                .col-xs-8
                                    input#search-input.form-control.ignore-kolich(type="text")
                                .col-xs-2
                                    button#search-button.form-control.btn.btn-default
                                        span.glyphicon.glyphicon-search
                                .col-xs-2
                                    button#start_recognition_button(style="background-color:transparent;border:0;")
                                        img#mic_on(alt="Start", src="/images/mic_off.png", height="40px", style="display:none")
                                        img#mic_off(alt="End", src="/images/mic_on.png", height="40px", style="display:none")
                            .row#search-results


        footer
            .container
                .row
                    .col-xs-6
                        .col-xs-9
                            #send-message-area
                                textarea#sendie
                        .col-xs-3(style="padding-left:0px;")
                            block video
                    .col-xs-6
                        .row
                            block extraLine1
                        .row
                            block extraLine2
                        .row
                            .col-xs-5.col-xs-offset-7
                                label &copy; 2015 SolidWorks Solutions

        script(type='text/javascript', src='/javascripts/jquery-2.1.4.min.js')
        script(type='text/javascript', src='/javascripts/bootstrap.min.js')
        script(type='text/javascript', src='/javascripts/socket.io-1.3.5.js')
        script(type='text/javascript', src='/javascripts/peer.js')
        //script(type='text/javascript', src='/javascripts/etherpad.js')
        script(type='text/javascript', src="https://www.google.com/jsapi")

        script.
            var socket = io();
            var peer = new Peer({key: 'bp70suzmx5ok1emi'});
            var mediaStream = null;
            var classRoom = '#{classRoom}';

            var color = "";
            var suggest = "";

            var json = JSON.parse('!{messages}'),
                messages;

            if (json.length > 0)
                messages = json[0].messages;

            var sp = $("#search-panel"),
                chat_area = $('#chat-area'),
                search_input = $('#search-input'),
                search_button = $('#search-button');

            var recognition = null;

            if(!('webkitSpeechRecognition' in window)){
                $("#mic_off").show();
                $("#mic_on").hide();
                alert('SU BROWSER NO TIENE HABILITADO EL RECONOCIMIENTO DE VOZ. POR FAVOR ACTUALICELO, DE LO CONTRARIO NO PODRA UTILIZAR ESA FUNCIONALIDAD');
            } else {
                recognition = new webkitSpeechRecognition();
                recognition.lang = 'es-AR';
                //recognition.lang = 'pt-BR';
                //recognition.continuous = true;
                //recognition.interimResults = true;
                $("#mic_on").show();
                $("#mic_off").hide();
            }

            //**********************+BUSCADOR***********************//
            google.load('search', '1', {"language": "pt_br"});

            var imageSearch;
            function OnLoad() {
                // Our ImageSearch instance.
                imageSearch = new google.search.ImageSearch();
                imageSearch.setResultSetSize(8);
                imageSearch.setSearchCompleteCallback(this, searchComplete, [imageSearch]);
            }
            google.setOnLoadCallback(OnLoad);

            function removeImg(idRemove){
                var elementToRemove = $("#" + idRemove);
                if(elementToRemove != null){
                    elementToRemove.remove();
                }
            }

            function fullSizeImage(aImageId){
                socket.emit('full size image', {urlImage: $('#img_'+aImageId).attr('src'), input: search_input.val(),classRoom: classRoom});
            }

            function searchComplete(searcher) {
                if (!searcher.results) return;

                var sr = $('#search-results');
                sr.html('');

                var agregados = 0;

                if (searcher.results.length > 0) {
                    var randomSearchId = Math.floor(Math.random() * 1000000000) + 1;
                    for (var i = 0; i < searcher.results.length; i++) {
                        var result = searcher.results[i];

                        var randomImageId = Math.floor(Math.random() * 1000000000) + 1;
                        sr.append(
                                '<div class="col-xs-4 search-result">\
                                    <a id="'+randomImageId+'" href="javascript:fullSizeImage('+randomImageId+')" target="_blank"><img id="img_'+randomImageId+'" onerror="removeImg('+randomImageId+')" class="search-results-image" src="' + result.url + '"></a>\
                                            </div>'
                        );
                        agregados++;
                        if ((agregados) % 3 == 0){
                            sr.append('<div class="separator"></div>');
                        }
                    }
                } else {
                    sr.html('Sem resultados');
                }
            }

            //******************************************************//

            //*********************KOLICH********************//
            if (!window.Kolich){
              Kolich = {};
            }

            Kolich.Selector = {};
            Kolich.Selector.getSelected = function(){
              var t = '';
              if(window.getSelection){
                t = window.getSelection();
              }else if(document.getSelection){
                t = document.getSelection();
              }else if(document.selection){
                t = document.selection.createRange().text;
              }
              return t;
            };

            Kolich.Selector.mouseup = function(){
                var st = Kolich.Selector.getSelected();
                if ((st + "").trim() == '' ||
                        $(st.focusNode).hasClass('ignore-kolich') ||
                        $(st.focusNode.parentNode).hasClass('ignore-kolich') ||
                        $(st.focusNode.firstChild).hasClass('ignore-kolich')) return;

                var input = search_input;
                //if (input.val() != "") //--Agregar coma
                //    st = ", " + st;
                //input.val(input.val() + st);

                input.val(st); //a pedido de Nicolas, cuando selecciona con el kolich queda eso solo en el input y busca y comparte
                //input.focus();
                search_button.click();
                sendSearch();
            };

            //**********************************************//
            function sendSearch() {
                socket.emit('search changed', {text: search_input.val(), classRoom: classRoom});
            }

            $(document).ready(function(){

                var event_search;

                search_button.on('click', function(){
                    clearTimeout(event_search);
                    var items = search_input.val().split(',');
                    imageSearch.execute(items[items.length - 1].trim());
                });

                search_input.on('keydown', function(e) {
                    if (e.which == 17) { //--Comparte la búsqueda con CTRL
                        search_button.click();
                        sendSearch();
                    } else if (e.keyCode == 13){
                        search_button.click();
                    }

                    //e.preventDefault();
                });

                search_input.on('input', function(e) {
                    clearTimeout(event_search);
                    event_search = setTimeout(function () {
                        search_button.click();
                        console.log(search_input.val());
                    }, 1000);
                });

                $(document).bind("mouseup", Kolich.Selector.mouseup);

                //************SOCKET EVENTS********************//
                socket.on('search changed', function(data){
                    if (data.classRoom == classRoom){
                        search_input.val(data.text);
                        search_button.click();
                    }
                });

                socket.on('newMessageChat', function (data) {
                    if (data.classRoom == classRoom){
                        addChatMsg(data, false);
                    }
                });

                socket.on('messageChatChanged', function (data) {
                    if (data.classRoom == classRoom){
                        $("#" + data.inputId + ' .msg-text').text(data.text);
                    }
                });

                socket.on('messageRemoved', function (data) {
                    removeChatMsg(data.inputId);
                });

                socket.on('full size image', function (data) {
                    if (data.classRoom == classRoom){
                        search_input.val(data.input);
                        var imageUrl = data.urlImage;
                        var sr = $('#search-results');
                        sr.empty();

                        var myImage = new Image();
                        myImage.className  = "search-results-big-image";
                        myImage.src = imageUrl;

                        sr.append(myImage);
                    }
                });

                socket.on('clear search images', function (data) {
                    if (data.classRoom == classRoom){
                        search_input.val('');
                        var sr = $('#search-results');
                        sr.empty();
                    }
                });
                //**********************************************//

                //************VOICE RECOGNITION********************//
                if(recognition != null){
                    recognition.onstart = function() {
                        $("#mic_on").hide();
                        $("#mic_off").show();
                    }

                    var final_transcript = '';

                    recognition.onresult = function(event) {
                        var interim_transcript = '';

                        for (var i = 0; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                final_transcript += event.results[i][0].transcript;
                            } else {
                                interim_transcript += event.results[i][0].transcript;
                            }
                        }

                        if(final_transcript != ''){
                            var input = search_input;
                            if (input.val() != "") //--Agregar coma
                                final_transcript = ", " + final_transcript;

                            input.val(input.val() + final_transcript);
                            input.focus();
                            final_transcript = '';
                            search_button.click();
                        }

                        //final_transcript = capitalize(final_transcript);
                        //final_span.innerHTML = linebreak(final_transcript);
                        //interim_span.innerHTML = linebreak(interim_transcript);

                        //alert(final_transcript);
                    }

                    recognition.onerror = function(event) {
                        alert('ERROR SPEECH RECOGNITION');
                        $("#mic_off").hide();
                        $("#mic_on").show();
                    }

                    recognition.onend = function() {
                        $("#mic_off").hide();
                        $("#mic_on").show();
                    }

                    $("#mic_on").click(function(){
                        recognition.start();
                        $("#mic_on").hide();
                        $("#mic_off").show();
                    });

                    $("#mic_off").click(function(){
                        recognition.stop();
                        $("#mic_off").hide();
                        $("#mic_on").show();
                    });
                }
                //*********************************************//

                $('#sendie').keydown(function (e) {
                    processKeyDownChat(e);
                });

                chat_area.on("keydown", ".chatInput .msg-text", function(e){
                    if (e.which != 13 || e.shiftKey) return;

                    var inputId = $(e.target).parent().attr('id');
                    var item = $("#" + inputId);
                    var inputValue = $(e.target).text();

                    socket.emit('messageChatChanged', { text: inputValue, inputId: inputId, classRoom: classRoom});

                    item.removeClass('msg-pending');
                    e.preventDefault();
                });

                chat_area.on('input', '.chatInput .msg-text', function(e){
                    $(e.target).parent().addClass('msg-pending');
                    if ($(e.target).text() == "")
                        $(e.target).text(' ');
                });

                $(messages).each(function(i, data) {
                    if (profesor) {
                        addChatMsg(data, data.teacher);
                    }else {
                        addChatMsg(data, false); //si no es profesor, se agregan como si fueran de otros porque no podemos identifcar alumnos aun
                    }
                });


            });

            function removeChatMsg(id) {
                var msg = $('#' + id);
                if (!msg.prev().hasClass('chatInput') && !msg.next().hasClass('chatInput')) {
                    msg.prev().remove();
                    msg.prev().remove();
                }
                msg.remove();
            }

            function padLeft(nr, n, str) {
                return Array(n - String(nr).length + 1).join(str || '0') + nr;
            }

            function addChatMsg(data, sent){
                var date = new Date(data.inputId);
                var msg =
                        '<div contentEditable="false" id="' + data.inputId + '" \
                                class="form-control chatInput ' + (sent? 'msg-sent' : 'msg-rcv')+ '" data-sender="' + data.author + '">\
                                <span class="msg-text" contenteditable="true">' + data.text + '</span>\
                                ' + getRemove() + '\
                                <span contenteditable="false" class="msg-date">' +
                        padLeft(date.getDate(),2) + "/" + padLeft(date.getMonth() + 1, 2) + "/" + padLeft(date.getYear() + 1900, 4) + ' ' + padLeft(date.getHours(),2) + ':' + padLeft(date.getMinutes(),2) + '</span>\
                            </div>';

                var chat_area = $('#chat-area');
                var last = $('#chat-area>*:last-child');

                if (last.length == 0 || data.author != last.data('sender'))
                    chat_area.append('\
                                <hr class="chat-separator">\
                                <span class="msg-sender ' + (sent? 'msg-sender-sent' : 'msg-sender-rcv') + '">' +
                            data.author.substring(0, 9) + '</span>');

                chat_area.append(msg);
                document.getElementById('chat-area').scrollTop = document.getElementById('chat-area').scrollHeight;
            }

        block javascript